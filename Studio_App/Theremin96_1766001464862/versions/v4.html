<!--
APP_NAME: Theremin 96
APP_DESCRIPTION: A modern, touch-friendly virtual theremin with dual-axis control and pitch guide.
APP_ICON: 
APP_CATEGORY: Entertainment
WINDOW_WIDTH: 400
WINDOW_HEIGHT: 500
STORE_ID: theremin-96
-->
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Theremin 96</title>
    <style>
        :root {
            --bg-color: #f3f3f3;
            --surface-color: #ffffff;
            --primary-color: #0078d4;
            --accent-vol: #00cc6a; /* Green for Volume */
            --accent-freq: #b146c2; /* Purple for Freq */
            --text-color: #202020;
            --shadow-sm: 0 2px 4px rgba(0,0,0,0.05);
            --shadow-md: 0 4px 12px rgba(0,0,0,0.1);
            --radius: 12px;
            --slider-width: 60px;
        }

        body {
            margin: 0;
            padding: 0;
            font-family: 'Segoe UI', system-ui, sans-serif;
            background-color: var(--bg-color);
            color: var(--text-color);
            height: 100vh;
            display: flex;
            flex-direction: column;
            overflow: hidden;
            user-select: none;
            -webkit-user-select: none;
        }

        /* Responsive Layout for Mobile Mode */
        body.mobile-mode {
            --slider-width: 80px;
        }

        /* App Container */
        .app-container {
            flex: 1;
            display: flex;
            flex-direction: column;
            padding: 16px;
            gap: 16px;
            box-sizing: border-box;
        }

        /* Header / Visualizer Area */
        .header {
            flex: 0 0 100px;
            background: var(--surface-color);
            border-radius: var(--radius);
            box-shadow: var(--shadow-sm);
            display: flex;
            align-items: center;
            justify-content: center;
            position: relative;
            overflow: hidden;
        }

        canvas#visualizer {
            width: 100%;
            height: 100%;
            opacity: 0.6;
        }

        .status-overlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            pointer-events: none;
        }

        .status-text {
            font-size: 14px;
            font-weight: 600;
            color: #666;
            margin-bottom: 4px;
        }

        .status-value {
            font-size: 24px;
            font-weight: 700;
            color: var(--text-color);
            font-feature-settings: "tnum";
            font-variant-numeric: tabular-nums;
        }

        /* Controls Container */
        .controls-area {
            flex: 1;
            display: flex;
            gap: 16px;
            justify-content: center;
            align-items: stretch;
            position: relative;
        }

        /* Slider Tracks */
        .slider-container {
            flex: 1;
            background: var(--surface-color);
            border-radius: var(--radius);
            box-shadow: var(--shadow-sm);
            position: relative;
            cursor: pointer;
            overflow: hidden;
            touch-action: none; /* CRITICAL: Prevent scrolling/zooming */
            transition: transform 0.1s;
        }

        .slider-container:active {
            transform: scale(0.99);
        }

        .slider-label {
            position: absolute;
            top: 16px;
            left: 0;
            width: 100%;
            text-align: center;
            font-size: 12px;
            font-weight: 600;
            color: #888;
            text-transform: uppercase;
            letter-spacing: 1px;
            pointer-events: none;
            z-index: 2;
        }

        .slider-fill {
            position: absolute;
            bottom: 0;
            left: 0;
            width: 100%;
            height: 0%; /* Dynamic */
            opacity: 0.2;
            pointer-events: none;
            transition: height 0.05s linear;
        }

        .slider-handle {
            position: absolute;
            left: 50%;
            bottom: 0%; /* Dynamic */
            width: 40px;
            height: 24px;
            border-radius: 12px;
            background: white;
            transform: translate(-50%, 50%);
            box-shadow: 0 2px 8px rgba(0,0,0,0.2);
            pointer-events: none;
            transition: bottom 0.05s linear;
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 3;
        }

        .slider-handle::after {
            content: '';
            width: 20px;
            height: 4px;
            background: rgba(0,0,0,0.1);
            border-radius: 2px;
        }

        /* Specific Colors */
        #volume-slider .slider-fill { background-color: var(--accent-vol); }
        #volume-slider .slider-handle { border: 2px solid var(--accent-vol); }
        
        #freq-slider .slider-fill { background-color: var(--accent-freq); }
        #freq-slider .slider-handle { border: 2px solid var(--accent-freq); }

        /* Note Markers */
        #note-markers {
            position: absolute;
            top: 0;
            bottom: 0;
            right: 0;
            width: 30%;
            pointer-events: none;
            z-index: 1;
        }

        .note-tick {
            position: absolute;
            right: 12px;
            width: 100%;
            height: 0;
            display: flex;
            align-items: center;
            justify-content: flex-end;
            transform: translateY(50%); /* Center vertically on the exact point */
        }

        .note-tick::after {
            content: '';
            width: 8px;
            height: 1px;
            background-color: #ccc;
            margin-left: 4px;
        }

        .note-text {
            font-size: 10px;
            font-weight: 600;
            color: #aaa;
            background: rgba(255, 255, 255, 0.85);
            padding: 0 2px;
            border-radius: 3px;
        }

        /* Power Button */
        .power-btn-container {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            z-index: 10;
        }

        #power-btn {
            width: 64px;
            height: 64px;
            border-radius: 50%;
            border: none;
            background: var(--surface-color);
            box-shadow: var(--shadow-md);
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s ease;
            outline: none;
        }

        #power-btn svg {
            width: 32px;
            height: 32px;
            fill: #ccc;
            transition: fill 0.3s;
        }

        #power-btn.active {
            box-shadow: 0 0 15px var(--primary-color), inset 0 0 10px rgba(0,0,0,0.05);
        }

        #power-btn.active svg {
            fill: var(--primary-color);
            filter: drop-shadow(0 0 5px var(--primary-color));
        }

        #power-btn:hover {
            transform: scale(1.05);
        }

        /* Help Text */
        .footer-info {
            text-align: center;
            font-size: 11px;
            color: #999;
            margin-top: 4px;
        }

    </style>
</head>
<body>

    <div class="app-container">
        
        <!-- Header / Visualizer -->
        <div class="header">
            <canvas id="visualizer"></canvas>
            <div class="status-overlay">
                <div class="status-text">OUTPUT</div>
                <div class="status-value" id="freq-display">OFF</div>
            </div>
        </div>

        <!-- Controls -->
        <div class="controls-area">
            <!-- Volume (Left) -->
            <div class="slider-container" id="volume-slider">
                <div class="slider-label">Volume</div>
                <div class="slider-fill" id="vol-fill"></div>
                <div class="slider-handle" id="vol-handle"></div>
            </div>

            <!-- Power Button (Center Overlay) -->
            <div class="power-btn-container">
                <button id="power-btn" aria-label="Power On/Off">
                    <svg viewBox="0 0 24 24">
                        <path d="M12,2A10,10 0 0,0 2,12A10,10 0 0,0 12,22A10,10 0 0,0 22,12A10,10 0 0,0 12,2M11,7H13V13H11V7M11,15H13V17H11V15Z" style="display:none;"/> 
                        <path d="M16.56,5.44L15.11,6.89C16.84,7.94 18,9.83 18,12A6,6 0 0,1 12,18A6,6 0 0,1 6,12C6,9.83 7.16,7.94 8.88,6.88L7.44,5.44C5.36,6.88 4,9.28 4,12A8,8 0 0,0 12,20A8,8 0 0,0 20,12C20,9.28 18.64,6.88 16.56,5.44M13,3H11V13H13" />
                    </svg>
                </button>
            </div>

            <!-- Frequency (Right) -->
            <div class="slider-container" id="freq-slider">
                <div class="slider-label">Pitch</div>
                <div class="slider-fill" id="freq-fill"></div>
                <div id="note-markers"></div>
                <div class="slider-handle" id="freq-handle"></div>
            </div>
        </div>

        <div class="footer-info">
            Tap Power to Start â€¢ Slide to Adjust
        </div>

    </div>

    <script>
        /**
         * Theremin 96 Logic
         */
        
        // --- State ---
        // Range updated to 2.5 octaves (C4 to approx 1480Hz)
        const state = {
            isOn: false,
            volume: 0.5, // 0.0 to 1.0
            freq: 0.5,   // 0.0 to 1.0 (mapped later)
            minFreq: 261.63, // C4
            maxFreq: 1480    // Approx 2.5 octaves (261.63 * 2^2.5)
        };

        // --- Audio Context ---
        let audioCtx;
        let masterGain;
        let oscillator;
        let lfo; // Vibrato
        let lfoGain;
        let analyser;
        
        // UI Sounds
        const createBeep = (freq, type = 'sine', duration = 0.1) => {
            if (!audioCtx) return;
            const osc = audioCtx.createOscillator();
            const gain = audioCtx.createGain();
            osc.type = type;
            osc.frequency.setValueAtTime(freq, audioCtx.currentTime);
            gain.gain.setValueAtTime(0.1, audioCtx.currentTime);
            gain.gain.exponentialRampToValueAtTime(0.001, audioCtx.currentTime + duration);
            osc.connect(gain);
            gain.connect(audioCtx.destination);
            osc.start();
            osc.stop(audioCtx.currentTime + duration);
        };

        // Initialize Audio Engine
        function initAudio() {
            if (!audioCtx) {
                const AudioContext = window.AudioContext || window.webkitAudioContext;
                audioCtx = new AudioContext();
            }
            if (audioCtx.state === 'suspended') {
                audioCtx.resume();
            }
        }

        function startTheremin() {
            if (!audioCtx) initAudio();
            
            // Nodes
            oscillator = audioCtx.createOscillator();
            oscillator.type = 'sine';
            
            masterGain = audioCtx.createGain();
            masterGain.gain.value = 0; // Start silent

            // Vibrato (LFO)
            lfo = audioCtx.createOscillator();
            lfo.frequency.value = 6; // 6Hz vibrato
            lfoGain = audioCtx.createGain();
            lfoGain.gain.value = 5; // Depth of vibrato
            lfo.connect(lfoGain);
            lfoGain.connect(oscillator.frequency);

            // Analyser
            analyser = audioCtx.createAnalyser();
            analyser.fftSize = 2048;

            // Compressor (limit clipping)
            const compressor = audioCtx.createDynamicsCompressor();

            // Connections
            oscillator.connect(masterGain);
            masterGain.connect(compressor);
            compressor.connect(analyser);
            analyser.connect(audioCtx.destination);

            oscillator.start();
            lfo.start();

            // Apply initial values
            updateAudioParams();
        }

        function stopTheremin() {
            if (oscillator) {
                // Ramp down to avoid click
                masterGain.gain.setTargetAtTime(0, audioCtx.currentTime, 0.05);
                setTimeout(() => {
                    if(oscillator) oscillator.stop();
                    if(lfo) lfo.stop();
                    oscillator = null;
                    lfo = null;
                }, 100);
            }
        }

        function updateAudioParams() {
            if (!oscillator || !masterGain) return;
            
            // Exponential mapping: min * (max/min)^val
            const targetFreq = state.minFreq * Math.pow(state.maxFreq / state.minFreq, state.freq);
            
            // Smooth transitions
            const now = audioCtx.currentTime;
            oscillator.frequency.setTargetAtTime(targetFreq, now, 0.05);
            
            // Volume
            masterGain.gain.setTargetAtTime(state.volume, now, 0.05);
        }


        // --- UI Interactions ---

        // DOM Elements
        const powerBtn = document.getElementById('power-btn');
        const freqDisplay = document.getElementById('freq-display');
        const volSlider = document.getElementById('volume-slider');
        const freqSlider = document.getElementById('freq-slider');
        const volFill = document.getElementById('vol-fill');
        const volHandle = document.getElementById('vol-handle');
        const freqFill = document.getElementById('freq-fill');
        const freqHandle = document.getElementById('freq-handle');

        // Setup Sliders with Optimization for Multitouch
        function setupSlider(element, isFreq) {
            let rect; // Cache dimensions during drag to avoid reflow

            const updateValue = (e) => {
                const clientY = e.clientY; 
                
                // Calculate 0-1 (0 at bottom, 1 at top)
                let val = 1 - ((clientY - rect.top) / rect.height);
                
                // Clamp
                val = Math.max(0, Math.min(1, val));

                if (isFreq) {
                    state.freq = val;
                    updateSliderVisuals(freqFill, freqHandle, val);
                } else {
                    state.volume = val;
                    updateSliderVisuals(volFill, volHandle, val);
                }
                
                updateAudioParams();
            };

            const onPointerDown = (e) => {
                e.preventDefault(); 
                // CRITICAL OPTIMIZATION: Calculate layout once per drag session
                rect = element.getBoundingClientRect(); 
                
                element.setPointerCapture(e.pointerId);
                element.addEventListener('pointermove', updateValue);
                element.addEventListener('pointerup', onPointerUp);
                element.addEventListener('pointercancel', onPointerUp);
                updateValue(e);
            };

            const onPointerUp = (e) => {
                element.removeEventListener('pointermove', updateValue);
                element.removeEventListener('pointerup', onPointerUp);
                element.removeEventListener('pointercancel', onPointerUp);
                element.releasePointerCapture(e.pointerId);
            };

            element.addEventListener('pointerdown', onPointerDown);
        }

        function updateSliderVisuals(fill, handle, val) {
            const percent = val * 100;
            fill.style.height = `${percent}%`;
            handle.style.bottom = `${percent}%`;
        }

        // Generate Note Markers
        function generateNoteMarkers() {
            const container = document.getElementById('note-markers');
            container.innerHTML = ''; // Clear previous
            const noteNames = ['C', 'C#', 'D', 'D#', 'E', 'F', 'F#', 'G', 'G#', 'A', 'A#', 'B'];
            
            // Constants for logarithmic mapping
            const minLog = Math.log(state.minFreq);
            const maxLog = Math.log(state.maxFreq);
            const rangeLog = maxLog - minLog;

            // Generate frequencies for MIDI notes approx 48 (C3) to 96 (C7)
            for (let midi = 48; midi <= 96; midi++) {
                // A4 (69) = 440Hz
                const freq = 440 * Math.pow(2, (midi - 69) / 12);
                
                if (freq < state.minFreq) continue;
                if (freq > state.maxFreq) break;

                const noteIndex = midi % 12;
                const noteName = noteNames[noteIndex];

                // Only render Natural notes (white keys)
                if (!noteName.includes('#')) {
                    // Calculate position (0.0 to 1.0)
                    const val = (Math.log(freq) - minLog) / rangeLog;
                    const percent = val * 100;

                    const marker = document.createElement('div');
                    marker.className = 'note-tick';
                    marker.style.bottom = `${percent}%`;
                    marker.innerHTML = `<span class="note-text">${noteName}</span>`;
                    container.appendChild(marker);
                }
            }
        }

        // Initialize
        setupSlider(volSlider, false); // Volume
        setupSlider(freqSlider, true); // Freq
        updateSliderVisuals(volFill, volHandle, state.volume);
        updateSliderVisuals(freqFill, freqHandle, state.freq);
        generateNoteMarkers();

        // Power Toggle
        powerBtn.addEventListener('click', () => {
            state.isOn = !state.isOn;
            
            if (state.isOn) {
                initAudio();
                startTheremin();
                powerBtn.classList.add('active');
                createBeep(880, 'sine', 0.1); // Power On Sound
            } else {
                stopTheremin();
                powerBtn.classList.remove('active');
                // DOM update handled here for OFF state
                freqDisplay.textContent = "OFF";
                createBeep(440, 'triangle', 0.1); // Power Off Sound
            }
        });

        // --- Visualizer ---
        const canvas = document.getElementById('visualizer');
        const ctx = canvas.getContext('2d');
        
        function resizeCanvas() {
            canvas.width = canvas.parentElement.offsetWidth;
            canvas.height = canvas.parentElement.offsetHeight;
        }
        window.addEventListener('resize', resizeCanvas);
        resizeCanvas();

        function drawVisualizer() {
            requestAnimationFrame(drawVisualizer);

            // 1. Handle Visualizer Drawing
            const w = canvas.width;
            const h = canvas.height;
            ctx.clearRect(0, 0, w, h);

            if (!state.isOn) {
                // Draw inactive line
                ctx.beginPath();
                ctx.moveTo(0, h/2);
                ctx.lineTo(w, h/2);
                ctx.strokeStyle = '#e0e0e0';
                ctx.lineWidth = 2;
                ctx.stroke();
                return;
            }

            // Update Text Display (Moved here from move handler to prevent lag)
            const targetFreq = state.minFreq * Math.pow(state.maxFreq / state.minFreq, state.freq);
            freqDisplay.textContent = Math.round(targetFreq) + ' Hz';

            // Draw Waveform
            if(analyser) {
                const bufferLength = analyser.frequencyBinCount;
                const dataArray = new Uint8Array(bufferLength);
                analyser.getByteTimeDomainData(dataArray);

                ctx.lineWidth = 2;
                // Dynamic color based on freq
                const hue = 260 + (state.freq * 100); 
                ctx.strokeStyle = `hsl(${hue}, 70%, 50%)`;

                ctx.beginPath();
                const sliceWidth = w * 1.0 / bufferLength;
                let x = 0;

                for(let i = 0; i < bufferLength; i++) {
                    const v = dataArray[i] / 128.0;
                    const y = v * h/2;

                    if(i === 0) ctx.moveTo(x, y);
                    else ctx.lineTo(x, y);

                    x += sliceWidth;
                }

                ctx.lineTo(canvas.width, canvas.height/2);
                ctx.stroke();
            }
        }

        drawVisualizer();

    </script>
</body>
</html>