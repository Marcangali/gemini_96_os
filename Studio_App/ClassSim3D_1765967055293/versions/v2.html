<!--
APP_NAME: ClassSim 3D
APP_DESCRIPTION: Interactive 3D classroom simulator. Manage students, keep order, and beware of goats!
APP_ICON: 
APP_CATEGORY: Games
WINDOW_WIDTH: 380
WINDOW_HEIGHT: 560
STORE_ID: class-sim-3d
-->
<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>ClassSim 3D</title>
<style>
    :root {
        --bg-color: #f3f4f6;
        --panel-bg: rgba(255, 255, 255, 0.85);
        --primary: #0078d4;
        --primary-hover: #006cc1;
        --danger: #d13438;
        --success: #107c10;
        --text: #201f1e;
        --desk-color: #8B5A2B;
        --floor-color: #e1d5c9;
    }

    body {
        font-family: 'Segoe UI', system-ui, -apple-system, sans-serif;
        background-color: var(--bg-color);
        color: var(--text);
        margin: 0;
        padding: 0;
        height: 100vh;
        overflow: hidden;
        user-select: none;
        display: flex;
        flex-direction: column;
    }

    /* Header */
    header {
        background: var(--panel-bg);
        backdrop-filter: blur(10px);
        padding: 10px 15px;
        border-bottom: 1px solid rgba(0,0,0,0.1);
        display: flex;
        justify-content: space-between;
        align-items: center;
        z-index: 10;
        box-shadow: 0 2px 4px rgba(0,0,0,0.05);
    }

    .stats {
        display: flex;
        gap: 15px;
        font-size: 13px;
        font-weight: 600;
    }

    .stat-item {
        display: flex;
        align-items: center;
        gap: 6px;
    }

    .stat-bar {
        width: 60px;
        height: 6px;
        background: #e0e0e0;
        border-radius: 3px;
        overflow: hidden;
    }

    .stat-fill {
        height: 100%;
        width: 50%;
        transition: width 0.3s ease, background-color 0.3s;
    }

    /* 3D Scene Viewport */
    .viewport {
        flex: 1;
        position: relative;
        overflow: hidden;
        background: radial-gradient(circle at center, #ffffff, #eef2f5);
        cursor: grab;
        perspective: 1000px;
        touch-action: none;
    }

    .viewport:active {
        cursor: grabbing;
    }

    .scene {
        position: absolute;
        top: 50%;
        left: 50%;
        width: 0;
        height: 0;
        transform-style: preserve-3d;
        transform: rotateX(55deg) rotateZ(0deg);
        transition: transform 0.1s ease-out;
    }

    /* Floor */
    .floor {
        position: absolute;
        width: 600px;
        height: 600px;
        background: 
            linear-gradient(45deg, #ccc 25%, transparent 25%, transparent 75%, #ccc 75%, #ccc),
            linear-gradient(45deg, #ccc 25%, transparent 25%, transparent 75%, #ccc 75%, #ccc);
        background-color: var(--floor-color);
        background-size: 40px 40px;
        background-position: 0 0, 20px 20px;
        opacity: 0.5;
        transform: translate(-50%, -50%);
        border: 10px solid #fff;
        box-shadow: 0 0 40px rgba(0,0,0,0.1);
    }

    /* Objects */
    .desk-group {
        position: absolute;
        transform-style: preserve-3d;
        transition: transform 0.5s ease;
    }

    .desk {
        position: absolute;
        width: 40px;
        height: 25px;
        background: var(--desk-color);
        transform: translate(-50%, -50%);
        box-shadow: 2px 2px 5px rgba(0,0,0,0.2);
        border-radius: 2px;
    }

    .desk::before {
        /* Legs simulation */
        content: '';
        position: absolute;
        top: 5px; left: 2px;
        width: 36px; height: 15px;
        background: rgba(0,0,0,0.2);
        transform: translateZ(-20px);
    }

    .student {
        position: absolute;
        width: 20px;
        height: 20px;
        background: #ffccaa; /* Skin tone base */
        border-radius: 50%;
        transform: translate(-50%, -50%) translateZ(15px);
        box-shadow: inset -2px -2px 4px rgba(0,0,0,0.2);
        transition: transform 0.3s cubic-bezier(0.34, 1.56, 0.64, 1), background-color 0.3s;
    }

    .student::after {
        /* Shirt */
        content: '';
        position: absolute;
        top: 50%; left: 50%;
        width: 24px; height: 24px;
        background: var(--shirt-color, #4a90e2);
        border-radius: 50%;
        transform: translate(-50%, -20%) translateZ(-8px);
        z-index: -1;
    }

    /* Student States */
    .student.sleeping {
        transform: translate(-50%, -50%) translateZ(5px) rotateX(90deg);
        background: #e0ac90;
    }

    .student.hand-up {
        transform: translate(-50%, -50%) translateZ(25px);
    }
    
    .student.hand-up::before {
        content: '';
        position: absolute;
        right: -8px; top: 0;
        width: 6px; height: 20px;
        background: var(--shirt-color);
        transform: rotateZ(-20deg);
        border-radius: 3px;
    }

    .student.disruptive {
        animation: shake 0.5s infinite;
    }

    /* GOAT STATE */
    .student.goat {
        background: #ffffff;
        border-radius: 40%;
        box-shadow: 0 0 5px rgba(255,255,255,0.5);
        animation: hop 0.6s infinite;
        width: 24px;
        height: 24px;
    }

    .student.goat::after {
        /* Beard/Snout override */
        background: #e0e0e0;
        width: 14px; height: 14px;
        top: 65%; left: 50%;
        border-radius: 4px 4px 50% 50%;
        z-index: 1;
        transform: translate(-50%, 0) translateZ(1px);
        box-shadow: inset 0 -2px 0 #333; /* Mouth */
    }

    .student.goat::before {
        /* Horns */
        content: '';
        position: absolute;
        top: -6px; left: -2px;
        width: 28px; height: 12px;
        background: transparent;
        border-left: 6px solid #555;
        border-right: 6px solid #555;
        border-radius: 0;
        transform: rotateX(-20deg);
        z-index: 0;
    }

    @keyframes shake {
        0% { transform: translate(-50%, -50%) translateZ(15px) rotateZ(0deg); }
        25% { transform: translate(-50%, -50%) translateZ(15px) rotateZ(10deg); }
        75% { transform: translate(-50%, -50%) translateZ(15px) rotateZ(-10deg); }
        100% { transform: translate(-50%, -50%) translateZ(15px) rotateZ(0deg); }
    }

    @keyframes hop {
        0%, 100% { transform: translate(-50%, -50%) translateZ(15px); }
        50% { transform: translate(-50%, -50%) translateZ(25px); }
    }

    /* Particles (Zzz, Exclamation) */
    .particle {
        position: absolute;
        font-weight: bold;
        font-size: 14px;
        pointer-events: none;
        animation: floatUp 1.5s forwards;
        white-space: nowrap;
        text-shadow: 0 1px 2px rgba(255,255,255,0.8);
    }

    @keyframes floatUp {
        0% { opacity: 1; transform: translate(-50%, -50%) translateZ(30px) scale(0.5); }
        100% { opacity: 0; transform: translate(-50%, -50%) translateZ(80px) scale(1.2); }
    }

    /* Controls */
    .controls {
        background: var(--panel-bg);
        backdrop-filter: blur(10px);
        padding: 15px;
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 10px;
        border-top: 1px solid rgba(0,0,0,0.1);
        z-index: 10;
    }

    .btn {
        background: #fff;
        border: 1px solid rgba(0,0,0,0.1);
        border-radius: 6px;
        padding: 12px;
        font-size: 14px;
        font-weight: 600;
        color: var(--text);
        cursor: pointer;
        transition: all 0.1s;
        display: flex;
        flex-direction: column;
        align-items: center;
        gap: 5px;
        box-shadow: 0 2px 4px rgba(0,0,0,0.05);
    }

    .btn:active {
        transform: scale(0.97);
        box-shadow: none;
        background: #f0f0f0;
    }

    .btn-primary { background: var(--primary); color: white; border: none; }
    .btn-primary:hover { background: var(--primary-hover); }
    
    .btn-danger { color: var(--danger); background: #fff5f5; border-color: #ffd7d7; }
    .btn-danger:hover { background: #fee2e2; }

    .btn i { font-size: 18px; font-style: normal; }

    /* Overlay */
    .overlay {
        position: absolute;
        top: 0; left: 0; right: 0; bottom: 0;
        background: rgba(255,255,255,0.8);
        backdrop-filter: blur(5px);
        display: flex;
        flex-direction: column;
        justify-content: center;
        align-items: center;
        z-index: 100;
        opacity: 0;
        pointer-events: none;
        transition: opacity 0.3s;
    }
    
    .overlay.active { opacity: 1; pointer-events: all; }
    .overlay h1 { margin: 0 0 10px 0; color: var(--primary); }
    .overlay p { color: #666; margin-bottom: 20px; text-align: center; padding: 0 20px; }

    /* Mobile Mode */
    .mobile-mode .controls {
        padding: 20px;
        gap: 15px;
    }
    .mobile-mode .btn {
        padding: 15px;
        font-size: 16px;
    }
    .mobile-mode .stats {
        flex-direction: column;
        gap: 5px;
    }
    .mobile-mode .stat-bar {
        width: 80px;
    }

</style>
</head>
<body>

    <header>
        <div class="stats">
            <div class="stat-item">
                <span>Noise:</span>
                <div class="stat-bar"><div id="noise-bar" class="stat-fill" style="background: var(--danger); width: 10%;"></div></div>
            </div>
            <div class="stat-item">
                <span>Order:</span>
                <div class="stat-bar"><div id="order-bar" class="stat-fill" style="background: var(--success); width: 80%;"></div></div>
            </div>
        </div>
        <div style="font-size: 12px; color: #666;">Class 3-B</div>
    </header>

    <div class="viewport" id="viewport">
        <div class="scene" id="scene">
            <div class="floor"></div>
            <!-- Desks and Students will be generated here -->
        </div>
    </div>

    <div class="controls">
        <button class="btn btn-primary" id="btn-teach">
            <i>üìö</i> Teach
        </button>
        <button class="btn" id="btn-quiz">
            <i>üìù</i> Pop Quiz
        </button>
        <button class="btn" id="btn-shush">
            <i>ü§´</i> Shush!
        </button>
        <button class="btn btn-danger" id="btn-bell">
            <i>üîî</i> End Class
        </button>
    </div>

    <div class="overlay" id="game-over">
        <h1 id="end-title">Class Dismissed</h1>
        <p id="end-msg">You survived the lesson.</p>
        <button class="btn btn-primary" onclick="location.reload()">New Class</button>
    </div>

<script>
    /**
     * CLASSROOM SIMULATOR 3D
     * No external libs. CSS 3D Transforms + Web Audio API.
     */

    // --- Audio Engine ---
    const AudioEngine = {
        ctx: null,
        init: function() {
            if (!this.ctx) {
                this.ctx = new (window.AudioContext || window.webkitAudioContext)();
            }
            if (this.ctx.state === 'suspended') {
                this.ctx.resume();
            }
        },
        playTone: function(freq, type, duration, vol = 0.1) {
            this.init();
            const osc = this.ctx.createOscillator();
            const gain = this.ctx.createGain();
            
            osc.type = type;
            osc.frequency.setValueAtTime(freq, this.ctx.currentTime);
            
            gain.gain.setValueAtTime(vol, this.ctx.currentTime);
            gain.gain.exponentialRampToValueAtTime(0.01, this.ctx.currentTime + duration);
            
            osc.connect(gain);
            gain.connect(this.ctx.destination);
            
            osc.start();
            osc.stop(this.ctx.currentTime + duration);
        },
        playNoise: function(duration) {
            this.init();
            const bufferSize = this.ctx.sampleRate * duration;
            const buffer = this.ctx.createBuffer(1, bufferSize, this.ctx.sampleRate);
            const data = buffer.getChannelData(0);
            for (let i = 0; i < bufferSize; i++) {
                data[i] = Math.random() * 2 - 1;
            }
            const noise = this.ctx.createBufferSource();
            noise.buffer = buffer;
            const gain = this.ctx.createGain();
            gain.gain.value = 0.05;
            gain.gain.exponentialRampToValueAtTime(0.001, this.ctx.currentTime + duration);
            noise.connect(gain);
            gain.connect(this.ctx.destination);
            noise.start();
        },
        playBleat: function() {
            this.init();
            const osc = this.ctx.createOscillator();
            const gain = this.ctx.createGain();
            osc.type = 'sawtooth';
            // Vibrato effect for Baaa
            const now = this.ctx.currentTime;
            osc.frequency.setValueAtTime(200, now);
            osc.frequency.linearRampToValueAtTime(180, now + 0.1);
            osc.frequency.linearRampToValueAtTime(210, now + 0.2);
            osc.frequency.linearRampToValueAtTime(190, now + 0.3);
            
            gain.gain.setValueAtTime(0.15, now);
            gain.gain.exponentialRampToValueAtTime(0.01, now + 0.5);
            
            osc.connect(gain);
            gain.connect(this.ctx.destination);
            osc.start();
            osc.stop(now + 0.5);
        },
        playPop: function() {
            this.playTone(600, 'sine', 0.1, 0.1);
        },
        playBell: function() {
            this.playTone(880, 'triangle', 1.5, 0.1);
            setTimeout(() => this.playTone(660, 'triangle', 1.5, 0.1), 200);
        },
        playShush: function() {
            this.playNoise(0.5);
        },
        playSuccess: function() {
            this.playTone(440, 'sine', 0.1);
            setTimeout(() => this.playTone(554, 'sine', 0.1), 100);
            setTimeout(() => this.playTone(659, 'sine', 0.2), 200);
        },
        playFail: function() {
            this.playTone(150, 'sawtooth', 0.4, 0.1);
        }
    };

    // --- Simulation Logic ---
    const CONFIG = {
        studentCount: 20,
        rows: 5,
        cols: 4,
        deskSpacingX: 60,
        deskSpacingY: 80
    };

    const STATE = {
        students: [], // { id, state: 'idle'|'sleeping'|'hand-up'|'disruptive'|'goat', attention: 100 }
        noiseLevel: 10,
        orderLevel: 90,
        isRunning: true,
        rotation: 0
    };

    const SHIRT_COLORS = ['#e74c3c', '#3498db', '#2ecc71', '#f1c40f', '#9b59b6', '#34495e', '#e67e22'];

    // DOM Elements
    const scene = document.getElementById('scene');
    const viewport = document.getElementById('viewport');
    const noiseBar = document.getElementById('noise-bar');
    const orderBar = document.getElementById('order-bar');

    // Init Scene
    function initScene() {
        const startX = -((CONFIG.cols - 1) * CONFIG.deskSpacingX) / 2;
        const startY = -((CONFIG.rows - 1) * CONFIG.deskSpacingY) / 2;

        for (let i = 0; i < CONFIG.studentCount; i++) {
            const row = Math.floor(i / CONFIG.cols);
            const col = i % CONFIG.cols;
            
            const x = startX + col * CONFIG.deskSpacingX;
            const y = startY + row * CONFIG.deskSpacingY;

            // Create Desk Group
            const group = document.createElement('div');
            group.className = 'desk-group';
            group.style.transform = `translate3d(${x}px, ${y}px, 0)`;

            // Desk
            const desk = document.createElement('div');
            desk.className = 'desk';
            group.appendChild(desk);

            // Student
            const student = document.createElement('div');
            student.className = 'student';
            student.id = `s-${i}`;
            // Random shirt
            student.style.setProperty('--shirt-color', SHIRT_COLORS[Math.floor(Math.random() * SHIRT_COLORS.length)]);
            group.appendChild(student);

            // Click listener
            student.addEventListener('click', (e) => {
                e.stopPropagation();
                interactStudent(i);
            });

            scene.appendChild(group);

            // Init State
            STATE.students.push({
                id: i,
                state: 'idle',
                attention: 80 + Math.random() * 20,
                el: student
            });
        }
    }

    // --- Interaction ---
    let isDragging = false;
    let startX = 0;
    let currentRotation = 0;

    viewport.addEventListener('mousedown', (e) => {
        isDragging = true;
        startX = e.clientX;
    });

    window.addEventListener('mousemove', (e) => {
        if (!isDragging) return;
        const delta = e.clientX - startX;
        STATE.rotation = currentRotation - delta * 0.5;
        updateCamera();
    });

    window.addEventListener('mouseup', () => {
        if (isDragging) {
            isDragging = false;
            currentRotation = STATE.rotation;
        }
    });
    
    // Touch support for rotation
    viewport.addEventListener('touchstart', (e) => {
        isDragging = true;
        startX = e.touches[0].clientX;
    }, {passive: true});

    window.addEventListener('touchmove', (e) => {
        if (!isDragging) return;
        const delta = e.touches[0].clientX - startX;
        STATE.rotation = currentRotation - delta * 0.5;
        updateCamera();
    }, {passive: true});

    window.addEventListener('touchend', () => {
        if (isDragging) {
            isDragging = false;
            currentRotation = STATE.rotation;
        }
    });

    function updateCamera() {
        scene.style.transform = `rotateX(55deg) rotateZ(${STATE.rotation}deg)`;
    }

    // --- Game Logic ---

    function interactStudent(id) {
        if (!STATE.isRunning) return;
        const s = STATE.students[id];
        
        // Interaction logic
        if (s.state === 'goat') {
            shooGoat(s);
        } else {
            AudioEngine.playPop();
            if (s.state === 'sleeping') {
                wakeUp(s);
            } else if (s.state === 'hand-up') {
                answerQuestion(s);
            } else if (s.state === 'disruptive') {
                discipline(s);
            } else {
                createParticle(s.el, '?', '#000');
            }
        }
        updateStats();
    }

    function wakeUp(s) {
        s.state = 'idle';
        s.attention = 50;
        updateStudentVisual(s);
        createParticle(s.el, '!', '#d13438');
    }

    function answerQuestion(s) {
        s.state = 'idle';
        STATE.orderLevel = Math.min(100, STATE.orderLevel + 5);
        s.attention += 20;
        AudioEngine.playSuccess();
        createParticle(s.el, '+10', '#107c10');
        updateStudentVisual(s);
    }

    function discipline(s) {
        s.state = 'idle';
        STATE.noiseLevel = Math.max(0, STATE.noiseLevel - 20);
        createParticle(s.el, 'Silence!', '#000');
        updateStudentVisual(s);
    }

    function shooGoat(s) {
        s.state = 'idle';
        AudioEngine.playBleat(); // Angry bleat on exit
        createParticle(s.el, 'Shoo!', '#555');
        STATE.orderLevel += 5;
        updateStudentVisual(s);
    }

    function updateStudentVisual(s) {
        s.el.className = 'student ' + s.state;
    }

    function createParticle(el, text, color) {
        const p = document.createElement('div');
        p.className = 'particle';
        p.innerText = text;
        p.style.color = color;
        // Append to parent (desk-group) so it moves with rotation
        el.parentElement.appendChild(p);
        setTimeout(() => p.remove(), 1500);
    }

    // --- Loop ---
    setInterval(() => {
        if (!STATE.isRunning) return;
        
        // Random Events
        const r = Math.floor(Math.random() * CONFIG.studentCount);
        const s = STATE.students[r];
        const eventRoll = Math.random();

        // Behavior Logic
        if (s.state === 'idle') {
            if (eventRoll < 0.05) {
                // Sleep
                s.state = 'sleeping';
                createParticle(s.el, 'Zzz', '#34495e');
            } else if (eventRoll < 0.1) {
                // Raise hand
                s.state = 'hand-up';
                AudioEngine.playTone(300, 'sine', 0.05);
            } else if (eventRoll < 0.15) {
                // Disruptive
                s.state = 'disruptive';
                STATE.noiseLevel = Math.min(100, STATE.noiseLevel + 10);
                STATE.orderLevel = Math.max(0, STATE.orderLevel - 5);
            } else if (eventRoll < 0.17) {
                // GOAT EVENT!
                s.state = 'goat';
                AudioEngine.playBleat();
                createParticle(s.el, 'BAAA!', '#000');
                STATE.noiseLevel += 15;
            }
        } 

        // Goat Passive Effects
        STATE.students.forEach(st => {
            if (st.state === 'goat') {
                STATE.noiseLevel += 0.5; // Goats are naturally noisy
                STATE.orderLevel -= 0.3; // Goats chaos
                if (Math.random() > 0.9) createParticle(st.el, 'munch', '#777');
            }
        });

        // Global Decay
        if (STATE.noiseLevel > 0) STATE.noiseLevel -= 0.5;
        if (STATE.noiseLevel > 50) STATE.orderLevel -= 0.5;
        
        // Noise Sound check
        if (STATE.noiseLevel > 60 && Math.random() > 0.8) {
            AudioEngine.playNoise(0.2);
        }

        updateStudentVisual(s);
        updateStats();

    }, 500);

    function updateStats() {
        noiseBar.style.width = `${Math.min(100, Math.max(0, STATE.noiseLevel))}%`;
        orderBar.style.width = `${Math.min(100, Math.max(0, STATE.orderLevel))}%`;
        
        // Check fail state
        if (STATE.orderLevel <= 0) {
            endGame(false);
        }
    }

    function endGame(victory) {
        STATE.isRunning = false;
        const overlay = document.getElementById('game-over');
        const title = document.getElementById('end-title');
        const msg = document.getElementById('end-msg');
        
        AudioEngine.playFail();
        
        if (victory) {
            title.innerText = "Class Dismissed!";
            msg.innerText = "Great job, Teacher!";
            title.style.color = "var(--success)";
        } else {
            title.innerText = "Total Chaos!";
            msg.innerText = "The principal has been called. Too many goats?";
            title.style.color = "var(--danger)";
        }
        overlay.classList.add('active');
    }

    // --- Controls ---
    document.getElementById('btn-teach').addEventListener('click', () => {
        if (!STATE.isRunning) return;
        AudioEngine.playTone(400, 'triangle', 0.2);
        STATE.orderLevel = Math.min(100, STATE.orderLevel + 10);
        // Slightly bores students
        STATE.students.forEach(s => {
            if (s.state === 'idle' && Math.random() > 0.9) {
                s.state = 'sleeping';
                updateStudentVisual(s);
                createParticle(s.el, 'Zzz', '#34495e');
            }
        });
        updateStats();
    });

    document.getElementById('btn-quiz').addEventListener('click', () => {
        if (!STATE.isRunning) return;
        AudioEngine.playTone(600, 'sawtooth', 0.3);
        // Wakes everyone up
        STATE.students.forEach(s => {
            if (s.state === 'sleeping' || s.state === 'disruptive') {
                s.state = 'idle';
                updateStudentVisual(s);
                createParticle(s.el, '!', '#000');
            }
        });
        STATE.orderLevel = Math.min(100, STATE.orderLevel + 20);
        STATE.noiseLevel += 10; // Panic noise
        updateStats();
    });

    document.getElementById('btn-shush').addEventListener('click', () => {
        if (!STATE.isRunning) return;
        AudioEngine.playShush();
        STATE.noiseLevel = Math.max(0, STATE.noiseLevel - 30);
        STATE.students.forEach(s => {
            if (s.state === 'disruptive') {
                s.state = 'idle';
                updateStudentVisual(s);
            }
            // Shushing goats helps a little
            if (s.state === 'goat') {
                createParticle(s.el, 'Bleat?', '#555');
            }
        });
        updateStats();
    });

    document.getElementById('btn-bell').addEventListener('click', () => {
        if (!STATE.isRunning) return;
        AudioEngine.playBell();
        if (STATE.orderLevel > 50) {
            setTimeout(() => endGame(true), 1000);
        } else {
            setTimeout(() => endGame(false), 1000);
        }
    });

    // Check responsiveness
    function checkMobile() {
        if (document.body.classList.contains('mobile-mode') || window.innerWidth < 450) {
            document.body.classList.add('mobile-mode');
            CONFIG.deskSpacingX = 50;
            CONFIG.deskSpacingY = 70;
            viewport.style.perspective = "800px";
        }
    }

    // Init
    checkMobile();
    initScene();
    updateStats();

</script>
</body>
</html>