<!--
APP_NAME: Theremin
APP_DESCRIPTION: Virtual theremin with pitch correction, volume control, and multiple waveforms.
APP_ICON: 
APP_CATEGORY: Entertainment
WINDOW_WIDTH: 400
WINDOW_HEIGHT: 500
VERSION_SUMMARY: Added Square waveform mode to settings
STORE_ID: theremin-96
-->
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Theremin</title>
    <style>
        :root {
            --bg-color: #f3f3f3;
            --surface-color: #ffffff;
            --primary-color: #0078d4;
            --accent-vol: #00cc6a;
            --accent-freq: #b146c2;
            --text-color: #202020;
            --shadow-sm: 0 2px 4px rgba(0,0,0,0.05);
            --shadow-md: 0 8px 16px rgba(0,0,0,0.12);
            --radius: 12px;
            --active-scale: 0.98;
            --overlay-bg: rgba(243, 243, 243, 0.8);
        }

        body {
            margin: 0;
            padding: 0;
            font-family: 'Segoe UI', system-ui, sans-serif;
            background-color: var(--bg-color);
            color: var(--text-color);
            height: 100vh;
            display: flex;
            flex-direction: column;
            overflow: hidden;
            user-select: none;
            -webkit-user-select: none;
        }

        /* Mobile Mode Adjustments */
        body.mobile-mode .control-panel {
            border-radius: 16px;
        }

        /* App Container */
        .app-container {
            flex: 1;
            display: flex;
            flex-direction: column;
            padding: 16px;
            gap: 16px;
            box-sizing: border-box;
            position: relative;
        }

        /* Header / Visualizer Area */
        .header {
            flex: 0 0 100px;
            background: var(--surface-color);
            border-radius: var(--radius);
            box-shadow: var(--shadow-sm);
            display: flex;
            align-items: center;
            justify-content: center;
            position: relative;
            overflow: hidden;
        }

        canvas#visualizer {
            width: 100%;
            height: 100%;
            opacity: 0.6;
        }

        .status-overlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            pointer-events: none;
        }

        .status-text {
            font-size: 14px;
            font-weight: 600;
            color: #666;
            margin-bottom: 4px;
        }

        .status-value {
            font-size: 24px;
            font-weight: 700;
            color: var(--text-color);
            font-feature-settings: "tnum";
            font-variant-numeric: tabular-nums;
        }

        /* Settings Button */
        .settings-btn {
            position: absolute;
            top: 12px;
            right: 12px;
            width: 32px;
            height: 32px;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.5);
            border: 1px solid rgba(0,0,0,0.05);
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 20;
            transition: all 0.2s;
            color: #555;
        }

        .settings-btn:hover {
            background: rgba(255, 255, 255, 0.9);
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            transform: rotate(15deg);
        }
        
        .settings-btn:active {
            transform: scale(0.95);
        }

        /* Controls Container */
        .controls-area {
            flex: 1;
            display: flex;
            gap: 16px;
            justify-content: center;
            align-items: stretch;
            position: relative;
        }

        /* Common Control Styles */
        .control-panel {
            flex: 1;
            background: var(--surface-color);
            border-radius: var(--radius);
            box-shadow: var(--shadow-sm);
            position: relative;
            overflow: hidden;
            touch-action: none;
            transition: transform 0.1s, box-shadow 0.2s;
        }

        .control-label {
            position: absolute;
            top: 16px;
            left: 0;
            width: 100%;
            text-align: center;
            font-size: 12px;
            font-weight: 600;
            color: #888;
            text-transform: uppercase;
            letter-spacing: 1px;
            pointer-events: none;
            z-index: 5;
        }

        /* LEFT SIDE: Volume Button */
        #volume-btn {
            cursor: pointer;
            display: flex;
            align-items: flex-end;
            justify-content: center;
            border: 2px solid transparent;
        }

        #volume-btn:not(.auto-mode):active {
            transform: scale(var(--active-scale));
        }

        #volume-btn.active-press {
            border-color: rgba(0, 204, 106, 0.3);
            box-shadow: 0 0 15px rgba(0, 204, 106, 0.2);
        }
        
        #volume-btn.auto-mode {
            cursor: default;
            border-color: rgba(0, 204, 106, 0.1);
        }

        .btn-fill {
            width: 100%;
            background-color: var(--accent-vol);
            opacity: 0.3;
            height: 0%; /* Dynamic */
            transition: none;
            pointer-events: none;
        }

        .btn-icon {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            pointer-events: none;
            color: var(--accent-vol);
            opacity: 0.5;
            transition: opacity 0.2s, transform 0.2s;
        }

        #volume-btn:active .btn-icon {
            opacity: 1;
            transform: translate(-50%, -50%) scale(1.1);
        }

        /* RIGHT SIDE: Pitch Slider */
        #freq-slider {
            cursor: ns-resize;
        }

        #freq-slider.slider-active:active {
            transform: scale(var(--active-scale));
        }

        .slider-fill {
            position: absolute;
            bottom: 0;
            left: 0;
            width: 100%;
            height: 0%; /* Dynamic */
            opacity: 0.2;
            pointer-events: none;
            transition: height 0.05s linear;
            background-color: var(--accent-freq);
        }

        .slider-handle {
            position: absolute;
            left: 50%;
            bottom: 0%; /* Dynamic */
            width: 40px;
            height: 24px;
            border-radius: 12px;
            background: white;
            transform: translate(-50%, 50%);
            box-shadow: 0 2px 8px rgba(0,0,0,0.2);
            pointer-events: none;
            transition: bottom 0.05s linear;
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 3;
            border: 2px solid var(--accent-freq);
        }

        .slider-handle::after {
            content: '';
            width: 20px;
            height: 4px;
            background: rgba(0,0,0,0.1);
            border-radius: 2px;
        }

        /* Note Markers */
        #note-markers {
            position: absolute;
            top: 0;
            bottom: 0;
            right: 0;
            width: 30%;
            pointer-events: none;
            z-index: 1;
        }

        .note-tick {
            position: absolute;
            right: 12px;
            width: 100%;
            height: 0;
            display: flex;
            align-items: center;
            justify-content: flex-end;
            transform: translateY(50%);
        }

        .note-tick::after {
            content: '';
            width: 8px;
            height: 1px;
            background-color: #ccc;
            margin-left: 4px;
        }

        .note-text {
            font-size: 10px;
            font-weight: 600;
            color: #aaa;
            background: rgba(255, 255, 255, 0.85);
            padding: 0 2px;
            border-radius: 3px;
        }

        /* Power Button */
        .power-btn-container {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            z-index: 10;
        }

        #power-btn {
            width: 64px;
            height: 64px;
            border-radius: 50%;
            border: none;
            background: var(--surface-color);
            box-shadow: var(--shadow-md);
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s ease;
            outline: none;
            position: relative;
        }

        #power-btn svg {
            width: 32px;
            height: 32px;
            fill: #ccc;
            transition: fill 0.3s;
        }

        #power-btn.active {
            box-shadow: 0 0 20px rgba(0, 120, 212, 0.4), inset 0 0 10px rgba(0,0,0,0.05);
        }

        #power-btn.active svg {
            fill: var(--primary-color);
            filter: drop-shadow(0 0 5px var(--primary-color));
        }

        #power-btn:hover {
            transform: scale(1.05);
        }

        /* Footer */
        .footer-info {
            text-align: center;
            font-size: 11px;
            color: #999;
            margin-top: 4px;
        }

        /* Settings Overlay */
        .settings-overlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: var(--overlay-bg);
            backdrop-filter: blur(8px);
            z-index: 100;
            display: flex;
            align-items: center;
            justify-content: center;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.2s;
        }

        .settings-overlay.visible {
            opacity: 1;
            pointer-events: auto;
        }

        .settings-card {
            background: var(--surface-color);
            width: 80%;
            max-width: 320px;
            padding: 24px;
            border-radius: 16px;
            box-shadow: var(--shadow-md);
            display: flex;
            flex-direction: column;
            gap: 16px;
            transform: translateY(10px);
            transition: transform 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        }

        .settings-overlay.visible .settings-card {
            transform: translateY(0);
        }

        .settings-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 1px solid #eee;
            padding-bottom: 12px;
            margin-bottom: 4px;
        }

        .settings-header h2 {
            margin: 0;
            font-size: 18px;
            font-weight: 600;
        }

        .close-btn {
            background: none;
            border: none;
            font-size: 24px;
            line-height: 1;
            color: #888;
            cursor: pointer;
            padding: 0;
        }

        .setting-row {
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .setting-label {
            font-size: 14px;
            font-weight: 500;
            color: #444;
        }
        
        .setting-label.disabled {
            opacity: 0.5;
        }

        /* Toggle Switch */
        .toggle {
            position: relative;
            display: inline-block;
            width: 44px;
            height: 24px;
        }

        .toggle input {
            opacity: 0;
            width: 0;
            height: 0;
        }

        .slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: #ccc;
            transition: .3s;
            border-radius: 24px;
        }

        .slider:before {
            position: absolute;
            content: "";
            height: 18px;
            width: 18px;
            left: 3px;
            bottom: 3px;
            background-color: white;
            transition: .3s cubic-bezier(0.4, 0.0, 0.2, 1);
            border-radius: 50%;
            box-shadow: 0 2px 4px rgba(0,0,0,0.2);
        }

        input:checked + .slider {
            background-color: var(--primary-color);
        }

        input:checked + .slider:before {
            transform: translateX(20px);
        }

        input:disabled + .slider {
            background-color: #eee;
            cursor: not-allowed;
        }

        /* Period Selector Styles */
        .sub-setting {
            margin-top: -8px;
            padding-left: 0;
            justify-content: flex-end;
            transition: opacity 0.3s;
        }
        
        .sub-setting.disabled {
            opacity: 0.3;
            pointer-events: none;
        }

        .period-selector {
            display: flex;
            background: #f0f0f0;
            border-radius: 8px;
            padding: 3px;
            gap: 2px;
        }

        .period-btn {
            border: none;
            background: transparent;
            padding: 6px 12px;
            border-radius: 6px;
            font-size: 12px;
            font-weight: 600;
            color: #666;
            cursor: pointer;
            transition: all 0.2s;
            min-width: 50px;
        }

        .period-btn:hover {
            background: rgba(0,0,0,0.05);
        }

        .period-btn.active {
            background: var(--surface-color);
            color: var(--primary-color);
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }
        
        hr.divider {
            border: none;
            border-top: 1px solid #eee;
            margin: 4px 0;
            width: 100%;
        }

    </style>
</head>
<body>

    <div class="app-container">
        
        <!-- Header / Visualizer -->
        <div class="header">
            <canvas id="visualizer"></canvas>
            <div class="status-overlay">
                <div class="status-text">OUTPUT</div>
                <div class="status-value" id="freq-display">OFF</div>
            </div>
            <!-- Settings Button -->
            <button class="settings-btn" id="settings-toggle-btn" aria-label="Settings">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor">
                    <path d="M19.14,12.94C19.14,12.78 19.14,12.61 19.14,12.45C19.14,12.29 19.14,12.12 19.14,11.96L21.41,10.19C21.61,10.03 21.67,9.75 21.54,9.5L19.38,5.78C19.25,5.55 18.96,5.46 18.73,5.54L16.06,6.62C15.5,6.19 14.9,5.84 14.25,5.57L13.84,2.73C13.8,2.46 13.57,2.27 13.3,2.27H8.97C8.7,2.27 8.47,2.46 8.43,2.73L8.03,5.57C7.37,5.84 6.77,6.19 6.22,6.62L3.54,5.54C3.31,5.46 3.02,5.55 2.89,5.78L0.73,9.5C0.6,9.75 0.66,10.03 0.86,10.19L3.13,11.96C3.13,12.12 3.13,12.29 3.13,12.45C3.13,12.61 3.13,12.78 3.13,12.94L0.86,14.71C0.66,14.87 0.6,15.15 0.73,15.4L2.89,19.12C3.02,19.35 3.31,19.44 3.54,19.36L6.22,18.28C6.77,18.71 7.37,19.06 8.03,19.33L8.43,22.17C8.47,22.44 8.7,22.63 8.97,22.63H13.3C13.57,22.63 13.8,22.44 13.84,22.17L14.25,19.33C14.9,19.06 15.5,18.71 16.06,18.28L18.73,19.36C18.96,19.44 19.25,19.35 19.38,19.12L21.54,15.4C21.67,15.15 21.61,14.87 21.41,14.71L19.14,12.94M11.14,15.29C9.46,15.29 8.1,13.93 8.1,12.25C8.1,10.57 9.46,9.21 11.14,9.21C12.82,9.21 14.18,10.57 14.18,12.25C14.18,13.93 12.82,15.29 11.14,15.29Z" />
                </svg>
            </button>
        </div>

        <!-- Controls -->
        <div class="controls-area">
            
            <!-- Volume Button (Left) -->
            <div class="control-panel" id="volume-btn">
                <div class="control-label" id="volume-label">Hold Vol</div>
                <!-- Icons for visual feedback -->
                <div class="btn-icon">
                    <svg viewBox="0 0 24 24" width="48" height="48" fill="currentColor">
                        <path d="M14,3.23V5.29C16.89,6.15 19,8.83 19,12C19,15.17 16.89,17.84 14,18.7V20.77C18,19.86 21,16.28 21,12C21,7.72 18,4.14 14,3.23M16.5,12C16.5,10.23 15.5,8.71 14,7.97V16C15.5,15.29 16.5,13.76 16.5,12M3,9V15H7L12,20V4L7,9H3Z" />
                    </svg>
                </div>
                <!-- Rising Fill -->
                <div class="btn-fill" id="vol-fill"></div>
            </div>

            <!-- Power Button (Center Overlay) -->
            <div class="power-btn-container">
                <button id="power-btn" aria-label="Power On/Off">
                    <svg viewBox="0 0 24 24">
                        <path d="M16.56,5.44L15.11,6.89C16.84,7.94 18,9.83 18,12A6,6 0 0,1 12,18A6,6 0 0,1 6,12C6,9.83 7.16,7.94 8.88,6.88L7.44,5.44C5.36,6.88 4,9.28 4,12A8,8 0 0,0 12,20A8,8 0 0,0 20,12C20,9.28 18.64,6.88 16.56,5.44M13,3H11V13H13" />
                    </svg>
                </button>
            </div>

            <!-- Frequency Slider (Right) -->
            <div class="control-panel slider-active" id="freq-slider">
                <div class="control-label" style="text-align: left; left: 12px;">Pitch</div>
                <div class="slider-fill" id="freq-fill"></div>
                <div id="note-markers"></div>
                <div class="slider-handle" id="freq-handle"></div>
            </div>
        </div>

        <div class="footer-info">
            Power On • Hold Left for Vol • Slide Right for Pitch
        </div>

        <!-- Settings GUI -->
        <div class="settings-overlay" id="settings-overlay">
            <div class="settings-card">
                <div class="settings-header">
                    <h2>Configuration</h2>
                    <button class="close-btn" id="close-settings">&times;</button>
                </div>
                
                <div class="setting-row">
                    <span class="setting-label">Snap to Scale</span>
                    <label class="toggle">
                        <input type="checkbox" id="snap-check" checked>
                        <span class="slider"></span>
                    </label>
                </div>

                <div class="setting-row">
                    <span class="setting-label" id="chromatic-label">½ Tones (Chromatic)</span>
                    <label class="toggle">
                        <input type="checkbox" id="chromatic-check" checked>
                        <span class="slider"></span>
                    </label>
                </div>

                <div class="setting-row" style="align-items:flex-start; flex-direction:column; gap:8px;">
                    <span class="setting-label">Waveform</span>
                    <div class="period-selector" style="width:100%">
                        <button class="period-btn waveform-btn active" data-val="sine" style="flex:1">Sine</button>
                        <button class="period-btn waveform-btn" data-val="triangle" style="flex:1">Tri</button>
                        <button class="period-btn waveform-btn" data-val="square" style="flex:1">Square</button>
                    </div>
                </div>

                <hr class="divider">

                <div class="setting-row">
                    <span class="setting-label">Automatic Volume</span>
                    <label class="toggle">
                        <input type="checkbox" id="autovol-check">
                        <span class="slider"></span>
                    </label>
                </div>

                <div class="setting-row sub-setting disabled" id="autovol-periods">
                    <div class="period-selector">
                        <button class="period-btn active" data-val="0.5">0.5s</button>
                        <button class="period-btn" data-val="1.0">1.0s</button>
                        <button class="period-btn" data-val="1.5">1.5s</button>
                    </div>
                </div>

            </div>
        </div>

    </div>

    <script>
        /**
         * Theremin Logic
         */
        
        // --- State ---
        const state = {
            isOn: false,
            volume: 0.0, // Start at 0
            freq: 0.5,   // 0.0 to 1.0 (raw position)
            snapToScale: true, 
            allowHalfTones: true, 
            waveform: 'sine', // 'sine', 'triangle', 'square'
            autoVolume: false,
            autoVolPeriod: 0.5,
            // Scale set to 2 Octaves (G4 to G6)
            minFreq: 392.00, 
            maxFreq: 1567.98 
        };

        // --- Audio Context ---
        let audioCtx;
        let masterGain;
        let oscillator;
        let toneFilter;
        let lfo; 
        let lfoGain;
        let analyser;
        
        // Sound Effect for UI
        const createBeep = (freq, type = 'sine', duration = 0.1) => {
            if (!audioCtx) {
                const AudioContext = window.AudioContext || window.webkitAudioContext;
                audioCtx = new AudioContext();
            }
            if (audioCtx.state === 'suspended') audioCtx.resume();
            
            const osc = audioCtx.createOscillator();
            const gain = audioCtx.createGain();
            osc.type = type;
            osc.frequency.setValueAtTime(freq, audioCtx.currentTime);
            gain.gain.setValueAtTime(0.05, audioCtx.currentTime);
            gain.gain.exponentialRampToValueAtTime(0.001, audioCtx.currentTime + duration);
            osc.connect(gain);
            gain.connect(audioCtx.destination);
            osc.start();
            osc.stop(audioCtx.currentTime + duration);
        };

        function initAudio() {
            if (!audioCtx) {
                const AudioContext = window.AudioContext || window.webkitAudioContext;
                audioCtx = new AudioContext();
            }
            if (audioCtx.state === 'suspended') {
                audioCtx.resume();
            }
        }

        function getFilterFrequencyForWaveform(type) {
            switch(type) {
                case 'triangle': return 1500;
                case 'square': return 3000;
                default: return 20000;
            }
        }

        function startTheremin() {
            if (!audioCtx) initAudio();
            
            // Oscillator Setup
            oscillator = audioCtx.createOscillator();
            oscillator.type = state.waveform;
            
            // Filter Setup
            toneFilter = audioCtx.createBiquadFilter();
            toneFilter.type = 'lowpass';
            toneFilter.frequency.value = getFilterFrequencyForWaveform(state.waveform);

            masterGain = audioCtx.createGain();
            masterGain.gain.value = 0; 

            // Vibrato (LFO)
            lfo = audioCtx.createOscillator();
            lfo.frequency.value = 6; 
            lfoGain = audioCtx.createGain();
            lfoGain.gain.value = 5; 
            lfo.connect(lfoGain);
            lfoGain.connect(oscillator.frequency);

            // Audio Path
            analyser = audioCtx.createAnalyser();
            analyser.fftSize = 2048;
            const compressor = audioCtx.createDynamicsCompressor();

            oscillator.connect(toneFilter);
            toneFilter.connect(masterGain);
            masterGain.connect(compressor);
            compressor.connect(analyser);
            analyser.connect(audioCtx.destination);

            oscillator.start();
            lfo.start();

            // Handle start state
            state.volume = 0;
            if (state.autoVolume) {
                startAutoVolumeLoop();
            } else {
                updateVolumeVisuals();
                updateAudioParams();
            }
        }

        function stopTheremin() {
            if (oscillator) {
                masterGain.gain.setTargetAtTime(0, audioCtx.currentTime, 0.05);
                setTimeout(() => {
                    if(oscillator) oscillator.stop();
                    if(lfo) lfo.stop();
                    oscillator = null;
                    lfo = null;
                    toneFilter = null;
                }, 100);
            }
            cancelAnimationFrame(volumeRafId);
        }

        function getTargetFrequency() {
            const rawFreq = state.minFreq * Math.pow(state.maxFreq / state.minFreq, state.freq);
            
            if (state.snapToScale) {
                let midi = 69 + 12 * Math.log2(rawFreq / 440);
                
                if (state.allowHalfTones) {
                    midi = Math.round(midi);
                } else {
                    const allowedNotes = [0, 2, 4, 5, 7, 9, 11];
                    const octave = Math.floor(midi / 12);
                    let closestMidi = -1;
                    let minDiff = 999;
                    
                    for (let o = octave - 1; o <= octave + 1; o++) {
                        for (let n of allowedNotes) {
                            const candidate = o * 12 + n;
                            const diff = Math.abs(candidate - midi);
                            if (diff < minDiff) {
                                minDiff = diff;
                                closestMidi = candidate;
                            }
                        }
                    }
                    midi = closestMidi;
                }
                const snappedFreq = 440 * Math.pow(2, (midi - 69) / 12);
                return snappedFreq;
            }
            return rawFreq;
        }

        function updateAudioParams() {
            if (!oscillator || !masterGain) return;
            
            const targetFreq = getTargetFrequency();
            const rampTime = state.snapToScale ? 0.02 : 0.05; 
            oscillator.frequency.setTargetAtTime(targetFreq, audioCtx.currentTime, rampTime);
            
            masterGain.gain.setTargetAtTime(state.volume, audioCtx.currentTime, 0.02);
        }

        function updateToneParams() {
            if (!oscillator || !toneFilter) return;
            
            if (oscillator.type !== state.waveform) {
                oscillator.type = state.waveform;
            }
            
            const newCutoff = getFilterFrequencyForWaveform(state.waveform);
            toneFilter.frequency.setTargetAtTime(newCutoff, audioCtx.currentTime, 0.1);
        }

        // --- UI Interactions ---

        // DOM Elements
        const powerBtn = document.getElementById('power-btn');
        const freqDisplay = document.getElementById('freq-display');
        const freqSlider = document.getElementById('freq-slider');
        const freqFill = document.getElementById('freq-fill');
        const freqHandle = document.getElementById('freq-handle');
        
        // Settings Elements
        const settingsOverlay = document.getElementById('settings-overlay');
        const settingsBtn = document.getElementById('settings-toggle-btn');
        const closeSettingsBtn = document.getElementById('close-settings');
        const snapCheck = document.getElementById('snap-check');
        const chromaticCheck = document.getElementById('chromatic-check');
        const chromaticLabel = document.getElementById('chromatic-label');
        const waveformBtns = document.querySelectorAll('.waveform-btn');
        
        // Auto Volume Elements
        const autoVolCheck = document.getElementById('autovol-check');
        const autoVolPeriods = document.getElementById('autovol-periods');
        const periodBtns = document.querySelectorAll('#autovol-periods .period-btn');
        
        // Volume Elements
        const volBtn = document.getElementById('volume-btn');
        const volFill = document.getElementById('vol-fill');
        const volLabel = document.getElementById('volume-label');

        // --- Settings Modal Logic ---
        function openSettings() {
            settingsOverlay.classList.add('visible');
            createBeep(600, 'sine', 0.05);
        }

        function closeSettings() {
            settingsOverlay.classList.remove('visible');
            createBeep(400, 'sine', 0.05);
        }

        settingsBtn.addEventListener('click', openSettings);
        closeSettingsBtn.addEventListener('click', closeSettings);
        settingsOverlay.addEventListener('click', (e) => {
            if(e.target === settingsOverlay) closeSettings();
        });

        // --- Settings Toggles ---
        snapCheck.addEventListener('change', (e) => {
            state.snapToScale = e.target.checked;
            if (state.snapToScale) {
                chromaticLabel.classList.remove('disabled');
                chromaticCheck.disabled = false;
            } else {
                chromaticLabel.classList.add('disabled');
                chromaticCheck.disabled = true;
            }
            createBeep(state.snapToScale ? 800 : 600, 'sine', 0.05);
            if (state.isOn) {
                updateAudioParams();
                updateFreqVisualsFromState();
            }
        });

        chromaticCheck.addEventListener('change', (e) => {
            state.allowHalfTones = e.target.checked;
            createBeep(state.allowHalfTones ? 900 : 700, 'sine', 0.05);
            if (state.isOn && state.snapToScale) {
                updateAudioParams();
                updateFreqVisualsFromState();
            }
        });

        // Waveform Selector Logic
        waveformBtns.forEach(btn => {
            btn.addEventListener('click', () => {
                waveformBtns.forEach(b => b.classList.remove('active'));
                btn.classList.add('active');
                state.waveform = btn.dataset.val;
                
                // Audio feedback
                let pitch = 800;
                if(state.waveform === 'triangle') pitch = 600;
                if(state.waveform === 'square') pitch = 400;
                createBeep(pitch, state.waveform, 0.1);

                if (state.isOn) updateToneParams();
            });
        });

        // --- Auto Volume Logic ---
        autoVolCheck.addEventListener('change', (e) => {
            state.autoVolume = e.target.checked;
            createBeep(state.autoVolume ? 800 : 600, 'square', 0.05);
            
            if (state.autoVolume) {
                autoVolPeriods.classList.remove('disabled');
                volBtn.classList.add('auto-mode');
                volLabel.textContent = "AUTO VOL";
                if (state.isOn) startAutoVolumeLoop();
            } else {
                autoVolPeriods.classList.add('disabled');
                volBtn.classList.remove('auto-mode');
                volLabel.textContent = "HOLD VOL";
                // Reset loop and volume
                cancelAnimationFrame(volumeRafId);
                state.volume = 0;
                updateAudioParams();
                updateVolumeVisuals();
            }
        });

        periodBtns.forEach(btn => {
            btn.addEventListener('click', () => {
                // Update active state UI
                periodBtns.forEach(b => b.classList.remove('active'));
                btn.classList.add('active');
                
                // Update State
                state.autoVolPeriod = parseFloat(btn.dataset.val);
                createBeep(1200, 'sine', 0.03);
            });
        });

        // --- Volume Loop Logic ---
        let volumeRafId = null;
        let lastTime = 0;
        let phase = 0;

        function updateVolumeVisuals() {
            volFill.style.height = `${state.volume * 100}%`;
        }

        function startAutoVolumeLoop() {
            cancelAnimationFrame(volumeRafId);
            lastTime = 0;
            phase = 0; // Reset phase for clean start
            
            const loop = (timestamp) => {
                if (!state.isOn || !state.autoVolume) return;

                if (!lastTime) lastTime = timestamp;
                const dt = (timestamp - lastTime) / 1000;
                lastTime = timestamp;

                // Increment phase
                phase += dt / state.autoVolPeriod;
                if (phase > 1) phase -= 1;

                // Sine wave 0->1->0 based on phase
                // -cos(2*pi*phase) goes -1 to 1.
                // 0.5 - 0.5*cos... maps to 0 to 1.
                state.volume = 0.5 - 0.5 * Math.cos(2 * Math.PI * phase);

                updateAudioParams();
                updateVolumeVisuals();
                volumeRafId = requestAnimationFrame(loop);
            };
            volumeRafId = requestAnimationFrame(loop);
        }

        function startVolumeIncrease() {
            if (!state.isOn || state.autoVolume) return; // Ignore in auto mode
            
            volBtn.classList.add('active-press');
            cancelAnimationFrame(volumeRafId);

            const ramp = () => {
                if (state.volume < 1.0) {
                    state.volume += 0.015; 
                    if (state.volume > 1.0) state.volume = 1.0;
                    
                    updateAudioParams();
                    updateVolumeVisuals();
                    
                    if (state.volume < 1.0) {
                        volumeRafId = requestAnimationFrame(ramp);
                    }
                }
            };
            volumeRafId = requestAnimationFrame(ramp);
        }

        function stopVolume() {
            if (state.autoVolume) return; // Don't reset in auto mode
            
            volBtn.classList.remove('active-press');
            cancelAnimationFrame(volumeRafId);
            state.volume = 0;
            updateAudioParams();
            updateVolumeVisuals();
        }

        // Add Listeners to Volume Button
        volBtn.addEventListener('mousedown', (e) => {
            if(e.button !== 0) return;
            startVolumeIncrease();
        });
        window.addEventListener('mouseup', stopVolume);
        
        volBtn.addEventListener('touchstart', (e) => {
            e.preventDefault();
            startVolumeIncrease();
        }, { passive: false });
        
        volBtn.addEventListener('touchend', (e) => {
            e.preventDefault();
            stopVolume();
        });
        volBtn.addEventListener('touchcancel', stopVolume);


        // --- Frequency Slider Logic ---
        
        function updateFreqVisualsFromState() {
            let displayVal = state.freq;
            if (state.snapToScale) {
                const snappedFreq = getTargetFrequency();
                displayVal = Math.log(snappedFreq / state.minFreq) / Math.log(state.maxFreq / state.minFreq);
                displayVal = Math.max(0, Math.min(1, displayVal));
            }
            const percent = displayVal * 100;
            freqFill.style.height = `${percent}%`;
            freqHandle.style.bottom = `${percent}%`;
        }

        function setupFreqSlider() {
            let rect; 
            const updateValue = (e) => {
                const clientY = e.clientY; 
                let val = 1 - ((clientY - rect.top) / rect.height);
                val = Math.max(0, Math.min(1, val));

                state.freq = val;
                
                updateFreqVisualsFromState();
                updateAudioParams();
            };

            const onPointerDown = (e) => {
                if (e.target.closest('.settings-overlay')) return;
                e.preventDefault(); 
                rect = freqSlider.getBoundingClientRect(); 
                freqSlider.setPointerCapture(e.pointerId);
                freqSlider.addEventListener('pointermove', updateValue);
                freqSlider.addEventListener('pointerup', onPointerUp);
                freqSlider.addEventListener('pointercancel', onPointerUp);
                updateValue(e);
            };

            const onPointerUp = (e) => {
                freqSlider.removeEventListener('pointermove', updateValue);
                freqSlider.removeEventListener('pointerup', onPointerUp);
                freqSlider.removeEventListener('pointercancel', onPointerUp);
                freqSlider.releasePointerCapture(e.pointerId);
            };

            freqSlider.addEventListener('pointerdown', onPointerDown);
        }

        // --- Initialization ---

        function generateNoteMarkers() {
            const container = document.getElementById('note-markers');
            container.innerHTML = ''; 
            const noteNames = ['C', 'C#', 'D', 'D#', 'E', 'F', 'F#', 'G', 'G#', 'A', 'A#', 'B'];
            const minLog = Math.log(state.minFreq);
            const maxLog = Math.log(state.maxFreq);
            const rangeLog = maxLog - minLog;

            for (let midi = 48; midi <= 108; midi++) {
                const freq = 440 * Math.pow(2, (midi - 69) / 12);
                if (freq < state.minFreq - 1) continue; 
                if (freq > state.maxFreq + 1) break;

                const noteIndex = midi % 12;
                if (!noteNames[noteIndex].includes('#')) {
                    const val = (Math.log(freq) - minLog) / rangeLog;
                    const percent = val * 100;
                    const marker = document.createElement('div');
                    marker.className = 'note-tick';
                    marker.style.bottom = `${percent}%`;
                    marker.innerHTML = `<span class="note-text">${noteNames[noteIndex]}</span>`;
                    container.appendChild(marker);
                }
            }
        }

        setupFreqSlider();
        generateNoteMarkers();
        updateFreqVisualsFromState();

        // Power Toggle
        powerBtn.addEventListener('click', () => {
            state.isOn = !state.isOn;
            
            if (state.isOn) {
                initAudio();
                startTheremin();
                powerBtn.classList.add('active');
                createBeep(880, 'sine', 0.1); 
            } else {
                stopTheremin();
                if(!state.autoVolume) stopVolume(); // Reset volume UI if not auto
                else {
                    // In auto mode, also visually reset
                    state.volume = 0;
                    updateVolumeVisuals();
                }
                powerBtn.classList.remove('active');
                freqDisplay.textContent = "OFF";
                createBeep(440, 'triangle', 0.1);
            }
        });

        // --- Visualizer Loop ---
        const canvas = document.getElementById('visualizer');
        const ctx = canvas.getContext('2d');
        
        function resizeCanvas() {
            canvas.width = canvas.parentElement.offsetWidth;
            canvas.height = canvas.parentElement.offsetHeight;
        }
        window.addEventListener('resize', resizeCanvas);
        resizeCanvas();

        function drawVisualizer() {
            requestAnimationFrame(drawVisualizer);
            const w = canvas.width;
            const h = canvas.height;
            ctx.clearRect(0, 0, w, h);

            if (!state.isOn) {
                ctx.beginPath();
                ctx.moveTo(0, h/2);
                ctx.lineTo(w, h/2);
                ctx.strokeStyle = '#e0e0e0';
                ctx.lineWidth = 2;
                ctx.stroke();
                return;
            }

            const targetFreq = getTargetFrequency();
            
            if (state.snapToScale && targetFreq > 0) {
                 const midi = Math.round(69 + 12 * Math.log2(targetFreq / 440));
                 const noteNames = ['C', 'C#', 'D', 'D#', 'E', 'F', 'F#', 'G', 'G#', 'A', 'A#', 'B'];
                 const note = noteNames[midi % 12];
                 const oct = Math.floor(midi / 12) - 1;
                 freqDisplay.textContent = `${note}${oct}`;
            } else {
                freqDisplay.textContent = Math.round(targetFreq) + ' Hz';
            }

            if(analyser) {
                const bufferLength = analyser.frequencyBinCount;
                const dataArray = new Uint8Array(bufferLength);
                analyser.getByteTimeDomainData(dataArray);

                ctx.lineWidth = 2;
                const hue = 260 + (state.freq * 100); 
                const sat = 30 + (state.volume * 70);
                ctx.strokeStyle = `hsl(${hue}, ${sat}%, 50%)`;

                ctx.beginPath();
                const sliceWidth = w * 1.0 / bufferLength;
                let x = 0;

                for(let i = 0; i < bufferLength; i++) {
                    const v = dataArray[i] / 128.0;
                    const y = v * h/2;
                    if(i === 0) ctx.moveTo(x, y);
                    else ctx.lineTo(x, y);
                    x += sliceWidth;
                }
                ctx.lineTo(canvas.width, canvas.height/2);
                ctx.stroke();
            }
        }
        drawVisualizer();

    </script>
</body>
</html>